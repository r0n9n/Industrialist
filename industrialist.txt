-- Pollution Display Script
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PollutionDisplayGui"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true

-- Create main frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Parent = screenGui
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 15, 50)
mainFrame.BackgroundTransparency = 0.3
mainFrame.BorderSizePixel = 0
mainFrame.Position = UDim2.new(0.5, -150, 0, 7)
mainFrame.Size = UDim2.new(0, 300, 0, 140)

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Close button (X)
local closeButton = Instance.new("TextButton")
closeButton.Name = "CloseButton"
closeButton.Parent = screenGui
closeButton.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
closeButton.BackgroundTransparency = 0.5
closeButton.Position = UDim2.new(0.5, 150, 0, 7)
closeButton.Size = UDim2.new(0, 25, 0, 25)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 0, 0)
closeButton.TextSize = 20

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 6)
closeCorner.Parent = closeButton

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- Title label
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "TitleLabel"
titleLabel.Parent = mainFrame
titleLabel.BackgroundTransparency = 1
titleLabel.Position = UDim2.new(0, 10, 0, 5)
titleLabel.Size = UDim2.new(1, -40, 0, 30)
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.Text = "Pollution Level"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 18
titleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Pollution display label
local pollutionLabel = Instance.new("TextLabel")
pollutionLabel.Name = "PollutionLabel"
pollutionLabel.Parent = mainFrame
pollutionLabel.BackgroundTransparency = 1
pollutionLabel.Position = UDim2.new(0, 10, 0, 40)
pollutionLabel.Size = UDim2.new(0.5, -20, 0, 50)
pollutionLabel.Font = Enum.Font.SourceSans
pollutionLabel.Text = "Calculating..."
pollutionLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
pollutionLabel.TextSize = 24
pollutionLabel.TextXAlignment = Enum.TextXAlignment.Center

-- Hourly increase label
local increaseLabel = Instance.new("TextLabel")
increaseLabel.Name = "IncreaseLabel"
increaseLabel.Parent = mainFrame
increaseLabel.BackgroundTransparency = 1
increaseLabel.Position = UDim2.new(0.5, 0, 0, 40)
increaseLabel.Size = UDim2.new(0.5, -10, 0, 50)
increaseLabel.Font = Enum.Font.SourceSans
increaseLabel.Text = "Calculating..."
increaseLabel.TextColor3 = Color3.fromRGB(150, 255, 150)
increaseLabel.TextSize = 16
increaseLabel.TextXAlignment = Enum.TextXAlignment.Center

-- Money per hour label
local moneyPerHourLabel = Instance.new("TextLabel")
moneyPerHourLabel.Name = "MoneyPerHourLabel"
moneyPerHourLabel.Parent = mainFrame
moneyPerHourLabel.BackgroundTransparency = 1
moneyPerHourLabel.Position = UDim2.new(0, 10, 0, 90)
moneyPerHourLabel.Size = UDim2.new(0.5, -20, 0, 40)
moneyPerHourLabel.Font = Enum.Font.SourceSans
moneyPerHourLabel.Text = "Calculating..."
moneyPerHourLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
moneyPerHourLabel.TextSize = 16
moneyPerHourLabel.TextXAlignment = Enum.TextXAlignment.Center

-- Money per second label
local moneyPerSecondLabel = Instance.new("TextLabel")
moneyPerSecondLabel.Name = "MoneyPerSecondLabel"
moneyPerSecondLabel.Parent = mainFrame
moneyPerSecondLabel.BackgroundTransparency = 1
moneyPerSecondLabel.Position = UDim2.new(0.5, 0, 0, 90)
moneyPerSecondLabel.Size = UDim2.new(0.5, -10, 0, 40)
moneyPerSecondLabel.Font = Enum.Font.SourceSans
moneyPerSecondLabel.Text = "Calculating..."
moneyPerSecondLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
moneyPerSecondLabel.TextSize = 14
moneyPerSecondLabel.TextXAlignment = Enum.TextXAlignment.Center

-- Drag functionality
local dragging = false
local dragStart
local startPos

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
    end
end)

mainFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        closeButton.Position = UDim2.new(mainFrame.Position.X.Scale, mainFrame.Position.X.Offset + 300, mainFrame.Position.Y.Scale, mainFrame.Position.Y.Offset)
    end
end)

-- Function to update pollution display
local lastPollutionValue = 0
local lastUpdateTime = tick()
local pollutionHistory = {}
local moneyHistory = {}
local maxHistorySize = 3600 -- Store up to 1 hour of data (at 1 update per second)

local function updatePollution()
    local pollutionValue = ReplicatedStorage:FindFirstChild("Pollution")
    if pollutionValue and pollutionValue:IsA("NumberValue") then
        local percentage = (pollutionValue.Value / 50000000) * 100
        pollutionLabel.Text = string.format("%.2f%%", percentage)
        
        -- Calculate hourly increase
        local currentTime = tick()
        local timeDelta = currentTime - lastUpdateTime
        
        -- Store pollution data with timestamp
        table.insert(pollutionHistory, {time = currentTime, value = pollutionValue.Value})
        
        -- Remove old entries outside of 1 hour window
        local oneHourAgo = currentTime - 3600
        while #pollutionHistory > 0 and pollutionHistory[1].time < oneHourAgo do
            table.remove(pollutionHistory, 1)
        end
        
        -- Calculate increase per hour
        local hourlyIncrease = 0
        if #pollutionHistory >= 2 then
            local firstEntry = pollutionHistory[1]
            local lastEntry = pollutionHistory[#pollutionHistory]
            local timeDiffSeconds = lastEntry.time - firstEntry.time
            
            if timeDiffSeconds > 0 then
                local pollutionDiff = lastEntry.value - firstEntry.value
                hourlyIncrease = (pollutionDiff / timeDiffSeconds) * 3600 -- Scale to per hour
            end
        end
        
        local increasePercentage = (hourlyIncrease / 50000000) * 100
        increaseLabel.Text = string.format("+%.2f%%/hr", increasePercentage)
        lastPollutionValue = pollutionValue.Value
        lastUpdateTime = currentTime
    else
        pollutionLabel.Text = "Pollution data not found"
        increaseLabel.Text = "N/A"
    end
    
    -- Update money per hour
    local moneyValue = ReplicatedStorage:FindFirstChild("Money")
    if moneyValue and moneyValue:IsA("NumberValue") then
        local currentTime = tick()
        
        -- Store money data with timestamp
        table.insert(moneyHistory, {time = currentTime, value = moneyValue.Value})
        
        -- Remove old entries outside of 1 hour window
        local oneHourAgo = currentTime - 3600
        while #moneyHistory > 0 and moneyHistory[1].time < oneHourAgo do
            table.remove(moneyHistory, 1)
        end
        
        -- Calculate average money per hour (count only positive gains)
        local moneyPerHour = 0
        if #moneyHistory >= 2 then
            local firstEntry = moneyHistory[1]
            local lastEntry = moneyHistory[#moneyHistory]
            local timeDiffSeconds = lastEntry.time - firstEntry.time

            if timeDiffSeconds > 0 then
                -- Sum only positive increments between consecutive entries
                local totalPositive = 0
                for i = 1, #moneyHistory - 1 do
                    local diff = moneyHistory[i + 1].value - moneyHistory[i].value
                    if diff > 0 then
                        totalPositive = totalPositive + diff
                    end
                end
                moneyPerHour = (totalPositive / timeDiffSeconds) * 3600 -- Scale to per hour
            end
        end
        
        moneyPerHourLabel.Text = string.format("Money/hr: +%.0f", moneyPerHour)
        
        -- Calculate money per second
        local moneyPerSecond = moneyPerHour / 3600
        moneyPerSecondLabel.Text = string.format("Money/sec: +%.2f", moneyPerSecond)
    else
        moneyPerHourLabel.Text = "Money data not found"
    end
end

-- Update every second
RunService.Heartbeat:Connect(function()
    updatePollution()
end)

-- Initial update
updatePollution()